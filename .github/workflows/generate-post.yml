name: Generate Weekly Blog Post

on:
  schedule:
    - cron: '0 9 * * 1'
  workflow_dispatch:
    inputs:
      category:
        description: 'Service pillar (leave empty for smart auto-selection)'
        required: false
        type: choice
        default: ''
        options:
          - ''
          - mobile-app-development
          - mvp-startup
          - ai-solutions
          - web-app-development
          - telegram-bot-development
          - crm-development
          - business-automation
          - saas-development
          - outsourcing
          - project-rescue
          - ecommerce
          - ui-ux-design
          - maintenance-support
          - cybersecurity
          - random
      customTopic:
        description: 'Custom topic (overrides category if set)'
        required: false
        type: string
        default: ''
      sourceUrl:
        description: 'URL to fetch and use as source material (overrides topic selection)'
        required: false
        type: string
        default: ''
      sourceText:
        description: 'Raw text as source material (overrides topic selection; max 5000 chars)'
        required: false
        type: string
        default: ''

jobs:
  generate:
    runs-on: ubuntu-latest
    environment: Production
    timeout-minutes: 30
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Generate blog post
        env:
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          UNSPLASH_ACCESS_KEY: ${{ secrets.UNSPLASH_ACCESS_KEY }}
          INPUT_CATEGORY: ${{ github.event.inputs.category }}
          INPUT_CUSTOM_TOPIC: ${{ github.event.inputs.customTopic }}
          INPUT_SOURCE_URL: ${{ github.event.inputs.sourceUrl }}
          INPUT_SOURCE_TEXT: ${{ github.event.inputs.sourceText }}
        run: |
          npx tsx scripts/generate-post.ts \
            --category "$INPUT_CATEGORY" \
            --customTopic "$INPUT_CUSTOM_TOPIC" \
            --sourceUrl "$INPUT_SOURCE_URL" \
            --sourceText "$INPUT_SOURCE_TEXT" \
            --locales "en,ru,uz"
